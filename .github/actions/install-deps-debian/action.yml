name: Install Deps Debian

description: Install build and test dependencies on Debian-based systems

runs:
  using: composite
  steps:
    - uses: tarantool/setup-tarantool@v4
      with:
        tarantool-version: 2.11
    - run: |
        # FIXME(tarantool/setup-tarantool#58): We set up the tarantool
        # repository in order to install tt. Ideally, this should be done
        # by the setup-tarantool action.
        curl -L https://tarantool.io/release/2/installer.sh | sudo bash
        apt-get --allow-releaseinfo-change update
        apt-get -y -f install \
          build-essential \
          ninja-build \
          lua5.1 \
          lcov \
          ruby-dev \
          liblz4-dev \
          libbenchmark-dev \
          autoconf \
          automake \
          libtool \
          util-linux \
          tt
        tt rocks install luatest 1.2.1
        tt rocks install luacheck 0.26.0
        gem install coveralls-lcov

        apt-get purge --auto-remove cmake -y
        apt-get install -y -f \
          software-properties-common \
          lsb-release
        wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc | \
            gpg --dearmor -o /usr/share/keyrings/kitware-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] \
          https://apt.kitware.com/ubuntu/ $(lsb_release -cs) main" | \
          sudo tee /etc/apt/sources.list.d/kitware.list > /dev/null
        apt-get --allow-releaseinfo-change update
        apt-get -y -f install \
          cmake=3.26.2-0kitware1ubuntu22.04.1 \
          cmake-data=3.26.2-0kitware1ubuntu22.04.1
      shell: bash
